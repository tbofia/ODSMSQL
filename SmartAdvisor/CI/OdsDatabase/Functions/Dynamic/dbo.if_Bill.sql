IF OBJECT_ID('dbo.if_Bill', 'IF') IS NOT NULL
    DROP FUNCTION dbo.if_Bill;
GO

CREATE FUNCTION dbo.if_Bill(
	@OdsPostingGroupAuditId INT
)
RETURNS TABLE
AS
RETURN
SELECT 
	 t.OdsPostingGroupAuditId,
	t.OdsCustomerId,
	t.OdsCreateDate,
	t.OdsSnapshotDate,
	t.OdsRowIsCurrent,
	t.OdsHashbytesValue,
	t.DmlOperation,
	t.ClientCode,
	t.BillSeq,
	t.ClaimSeq,
	t.ClaimSysSubSet,
	t.ProviderSeq,
	t.ProviderSubSet,
	t.PostDate,
	t.DOSFirst,
	t.Invoiced,
	t.InvoicedPPO,
	t.CreateUserID,
	t.CarrierSeqNew,
	t.DocCtrlType,
	t.DOSLast,
	t.PPONetworkID,
	t.POS,
	t.ProvType,
	t.ProvSpecialty1,
	t.ProvZip,
	t.ProvState,
	t.SubmitDate,
	t.ProvInvoice,
	t.Region,
	t.HospitalSeq,
	t.ModUserID,
	t.Status,
	t.StatusPrior,
	t.BillableLines,
	t.TotalCharge,
	t.BRReduction,
	t.BRFee,
	t.TotalAllow,
	t.TotalFee,
	t.DupClientCode,
	t.DupBillSeq,
	t.FupStartDate,
	t.FupEndDate,
	t.SendBackMsg1SiteCode,
	t.SendBackMsg1,
	t.SendBackMsg2SiteCode,
	t.SendBackMsg2,
	t.PPOReduction,
	t.PPOPrc,
	t.PPOContractID,
	t.PPOStatus,
	t.PPOFee,
	t.NGDReduction,
	t.NGDFee,
	t.URFee,
	t.OtherData,
	t.ExternalStatus,
	t.URFlag,
	t.Visits,
	t.TOS,
	t.TOB,
	t.SubProductCode,
	t.ForcePay,
	t.PmtAuth,
	t.FlowStatus,
	t.ConsultDate,
	t.RcvdDate,
	t.AdmissionType,
	t.PaidDate,
	t.AdmitDate,
	t.DischargeDate,
	t.TxBillType,
	t.RcvdBrDate,
	t.DueDate,
	t.Adjuster,
	t.DOI,
	t.RetCtrlFlg,
	t.RetCtrlNum,
	t.SiteCode,
	t.SourceID,
	t.CaseType,
	t.SubProductID,
	t.SubProductPrice,
	t.URReduction,
	t.ProvLicenseNum,
	t.ProvMedicareNum,
	t.ProvSpecialty2,
	t.PmtExportDate,
	t.PmtAcceptDate,
	t.ClientTOB,
	t.BRFeeNet,
	t.PPOFeeNet,
	t.NGDFeeNet,
	t.URFeeNet,
	t.SubProductPriceNet,
	t.BillSeqNewRev,
	t.BillSeqOrgRev,
	t.VocPlanSeq,
	t.ReviewDate,
	t.AuditDate,
	t.ReevalAllow,
	t.CheckNum,
	t.NegoType,
	t.DischargeHour,
	t.UB92TOB,
	t.MCO,
	t.DRG,
	t.PatientAccount,
	t.ExaminerRevFlag,
	t.RefProvName,
	t.PaidAmount,
	t.AdmissionSource,
	t.AdmitHour,
	t.PatientStatus,
	t.DRGValue,
	t.CompanySeq,
	t.TotalCoPay,
	t.UB92ProcMethod,
	t.TotalDeductible,
	t.PolicyCoPayAmount,
	t.PolicyCoPayPct,
	t.DocCtrlID,
	t.ResourceUtilGroup,
	t.PolicyDeductible,
	t.PolicyLimit,
	t.PolicyTimeLimit,
	t.PolicyWarningPct,
	t.AppBenefits,
	t.AppAssignee,
	t.CreateDate,
	t.ModDate,
	t.IncrementValue,
	t.AdjVerifRequestDate,
	t.AdjVerifRcvdDate,
	t.RenderingProvLastName,
	t.RenderingProvFirstName,
	t.RenderingProvMiddleName,
	t.RenderingProvSuffix,
	t.RereviewCount,
	t.DRGBilled,
	t.DRGCalculated,
	t.ProvRxLicenseNum,
	t.ProvSigOnFile,
	t.RefProvFirstName,
	t.RefProvMiddleName,
	t.RefProvSuffix,
	t.RefProvDEANum,
	t.SendbackMsg1Subset,
	t.SendbackMsg2Subset,
	t.PPONetworkJurisdictionInd,
	t.ManualReductionMode,
	t.WholesaleSalesTaxZip,
	t.RetailSalesTaxZip,
	t.PPONetworkJurisdictionInsurerSeq,
	t.InvoicedWholesale,
	t.InvoicedPPOWholesale,
	t.AdmittingDxRef,
	t.AdmittingDxCode,
	t.ProvFacilityNPI,
	t.ProvBillingNPI,
	t.ProvRenderingNPI,
	t.ProvOperatingNPI,
	t.ProvReferringNPI,
	t.ProvOther1NPI,
	t.ProvOther2NPI,
	t.ProvOperatingLicenseNum,
	t.EHubID,
	t.OtherBillingProviderSubset,
	t.OtherBillingProviderSeq,
	t.ResubmissionReasonCode,
	t.ContractType,
	t.ContractAmount,
	t.PriorAuthReferralNum1,
	t.PriorAuthReferralNum2,
	t.DRGCompositeFactor,
	t.DRGDischargeFraction,
	t.DRGInpatientMultiplier,
	t.DRGWeight,
	t.EFTPmtMethodCode,
	t.EFTPmtFormatCode,
	t.EFTSenderDFIID,
	t.EFTSenderAcctNum,
	t.EFTOrigCoSupplCode,
	t.EFTReceiverDFIID,
	t.EFTReceiverAcctQual,
	t.EFTReceiverAcctNum,
	t.PolicyLimitResult,
	t.HistoryBatchNumber,
	t.ProvBillingTaxonomy,
	t.ProvFacilityTaxonomy,
	t.ProvRenderingTaxonomy,
	t.PPOStackList,
	t.ICDVersion,
	t.ODGFlag,
	t.ProvBillLicenseNum,
	t.ProvFacilityLicenseNum,
	t.ProvVendorExternalID,
	t.BRActualClientCode,
	t.BROverrideClientCode,
	t.BillReevalReasonCode,
	t.PaymentClearedDate,
	t.EstimatedBRClientCode,
	t.EstimatedBRJuris,
	t.OverrideFeeControlRetail,
	t.OverrideFeeControlWholesale,
	t.StatementFromDate,
	t.StatementThroughDate
FROM src.Bill t
INNER JOIN (
	SELECT 
		OdsCustomerId,
		ClientCode,
		BillSeq,
		MAX(OdsPostingGroupAuditId) AS OdsPostingGroupAuditId
	FROM src.Bill
	WHERE OdsPostingGroupAuditId <= @OdsPostingGroupAuditId
	GROUP BY OdsCustomerId,
		ClientCode,
		BillSeq) s
ON t.OdsPostingGroupAuditId = s.OdsPostingGroupAuditId
	AND t.OdsCustomerId = s.OdsCustomerId
	AND t.ClientCode = s.ClientCode
	AND t.BillSeq = s.BillSeq
WHERE t.DmlOperation <> 'D';

GO


